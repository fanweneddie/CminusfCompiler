# Lab4 实验报告

小组成员 姓名 学号

## 实验要求

请按照自己的理解，写明本次实验需要干什么

## 实验难点

1. AST与语法树之间没有给出一一对应关系，需要对照AST生成代码与test_ast程序进行学习。
2. 类型推断需要重新设计部分结构
3. 对函数间array类型传递与想象中的不一样，结合了clang生成的ll文件才能正确理解。（上次思考题坑了）

## 实验设计

请写明为了顺利完成本次实验，加入了哪些亮点设计，并对这些设计进行解释。

1. 全局变量的判别
由于全局变量与局部变量在AST中均表达为`ASTVarDeclaration`节点类型。故通过对scope维护的栈，判断当前插入点是否在全局作用域来进行全局/局部变量判别。
2. 降低生成 IR 中的冗余
进行了三种优化以降低代码冗余。\
- 常量合并。对于常量表达式，将会在编译时对表达式的值进行计算，并替换为`Constant`类型。
- 不可达分支判别。若`ASTIterationStmt`，`ASTSelectionStmt`中包含不可达分支，生成的代码将不包含不可达分支中代码。
例如
```c
void main(void){
    int a;
    if(1 == 2){
        a = 1;
    }else{
        a = 2;
    }
    output(a);
}
```
将会生成如下的ll代码
```llvm
define void @main() {
label.1:
  %0 = alloca i32
  ; 判断与跳转被裁减
  store i32 2, i32* %0
  ; a=1不可达代码块被裁减
  %1 = load i32, i32* %0
  call void @output(i32 %1)
  ret void
}
```
- 不可达代码的判别
`return`,`neg_idx_except()`等语句后的代码均为不可达代码，程序将不会将这些代码编译输出到生成的ll文件中。
3. 较完整的错误类型判别
对于错误的输入，程序在大部分情况下能给出程序代码发生的第一个错误并给出错误类型提示。\
- 对于数组下标为负常数的情况程序能给出警告提示。
- 将变量定义为`void`类型将会提示类型错误。
- 对array/function类型进行赋值将会提示左值错误。
- 试图将void函数的返回值或array类型变量赋值给变量或参与运算将会提示类型错误。
- 当形参/实参数量不匹配时提示参数数量错误。
- 当形参/实参类型不匹配时提示参数类型错误(array->int/float或float/int->array)

### 实验总结



### 实验反馈 （可选 不会评分）

加大力度

### 组间交流 （可选）

NIL
